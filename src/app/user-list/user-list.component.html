<div class="container-fluid container-mt shadow-sm">
    <div class="row mb-4">
        <div class="col-sm-2"><h4>Users</h4></div>
        <div class="col-sm-10">
            <div class="d-flex justify-content-end align-items-center">
                <div class="mx-3">
                    <input type="text" [(ngModel)]="searchQuery" (input)="loadUsers()" placeholder="Search..."
                           class="form-control "/>
                </div>
                <button (click)="addUser(userModal)" class="btn btn-primary">Add User</button>
            </div>
        </div>
    </div>

    <!-- Table to display users -->
    <div class="table-wrapper">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Mobile Number</th>
                <th>Type</th>
                <!--                    <th>Email</th>-->
                <th class="text-center">Reward Points</th>
                <th class="text-center">Total Cash Reward</th>
                <th class="text-center">Status</th>
                <th class="text-center">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let user of users; let i = index">
                <td>{{ (currentPage - 1) * limit + (i + 1) }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.mobile }}</td>
                <td>{{ user.accountType }}</td>
                <!--                    <td>{{ user.email }}</td>-->
                <td class="text-primary cursor-pointer text-center"
                    (click)="showRedeemedPoints(user._id)">{{ user.redeemablePoints }}
                </td>
                <td class="text-primary cursor-pointer text-center" (click)="showRedeemedPoints(user._id)"
                    style="cursor: pointer">{{ user.cash }}
                </td>
                <td class="text-center">
                    <label class="switch">
                        <input type="checkbox" [checked]="user.status === 'active'"
                               (change)="toggleUserStatus(user._id, user.status, $event)">
                        <span class="slider round"></span>
                    </label>
                </td>


                <!-- Actions Column: Edit and Delete Buttons -->
                <td class="text-center">
<!--                    <button (click)="resetPasswordModalOpen(user, resetPasswordModal)" class="btn btn-primary mx-2"-->
<!--                            title="Reset password">-->
<!--                        <i class='bx bxs-key'></i>-->
<!--                    </button>-->
                    <button (click)="editUser(user, editUserModal)" class="btn btn-warning mx-2" title="Update">
                        <i class="bx bx-edit"></i>
                    </button>
                    <button (click)="deleteUser(user._id)" class="btn btn-danger mx-2" title="Delete">
                        <i class="bx bx-trash"></i>
                    </button>
                </td>
            </tr>
            <tr *ngIf="users.length === 0">
                <td class="text-center" colspan="8">No Records found</td>
            </tr>
            </tbody>
        </table>
    </div>


    <!-- Pagination Controls -->
    <!--        <div class="row">-->
    <!--            <div class="col-sm-12 text-right">-->
    <!--                <div class="d-flex justify-content-end">-->
    <!--                    <select [(ngModel)]="limit" (change)="handleLimitChange()" class="form-select mx-2" style="width:100px; margin-bottom: 16px">-->
    <!--                        <option *ngFor="let limitOption of limitOptions" [value]="limitOption">{{ limitOption }}</option>-->
    <!--                    </select>-->
    <!--                    <ngb-pagination class="mx-2"-->
    <!--                                    [(page)]="currentPage"-->
    <!--                                    [pageSize]="limit"-->
    <!--                                    [collectionSize]="totalPages"-->
    <!--                                    [boundaryLinks]="true"-->
    <!--                                    (pageChange)="handlePageChange($event)"-->
    <!--                                    [maxSize]="5">-->
    <!--                    </ngb-pagination>-->
    <!--                </div>-->
    <!--            </div>-->
    <!--        </div>-->
    <div class="d-flex justify-content-end">
        <div class="pagination-controls">
            <button (click)="prevPage()" [disabled]="currentPage === 1" class="btn btn-light">Previous</button>
            <span style="margin: 0 10px;">Page {{ currentPage }} of {{ totalPages }}</span>
            <button (click)="nextPage()" [disabled]="currentPage === totalPages" class="btn btn-light">Next</button>
        </div>
    </div>
</div>

<!-- Modal for Add User -->
<ng-template #userModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">Add User</h4>
    </div>
    <div class="modal-body">
        <form #userForm="ngForm" class="modal-box shadow-sm">
            <!-- Add Name -->
            <div class="row">
                <div class="col-sm-6 mb-3 form-group">
                    <label class="form-label" for="name">Name</label>
                    <input type="text" class="form-control" id="name" [(ngModel)]="currentUser.name" name="name"
                           required placeholder="Enter full name"/>
                </div>
                <!--            </div>-->

                <!-- Add Mobile Number (10 digits) -->
                <!--            <div class="row">-->
                <div class="col-sm-6 mb-3 form-group">
                    <label class="form-label" for="mobile">Mobile Number</label>
                    <input type="text" class="form-control" id="mobile" [(ngModel)]="currentUser.mobile" name="mobile"
                           maxlength="10" oninput="this.currentUser.mobile = this.currentUser.mobile.replace(/[^0-9]/g, '').slice(0, 10);"
                           pattern="^\d{10}$" required #mobile="ngModel" placeholder="Enter 10-digit mobile number"/>
                    <div *ngIf="mobile.invalid && mobile.touched" class="text-danger">
                        Mobile number must be exactly 10 digits.
                    </div>
                </div>
            </div>

            <!-- Add Password -->
<!--            <div class="row">-->
<!--                <div class="col-sm-6 mb-3 form-group">-->
<!--                    <label class="form-label" for="password">Password</label>-->
<!--                    <input type="password" class="form-control" id="password" [(ngModel)]="currentUser.password" name="password"-->
<!--                           required placeholder="Enter password"/>-->
<!--                </div>-->
<!--                &lt;!&ndash;            </div>&ndash;&gt;-->

<!--                &lt;!&ndash; Add Confirm Password &ndash;&gt;-->
<!--                &lt;!&ndash;            <div class="row">&ndash;&gt;-->
<!--                <div class="col-sm-6 mb-3 form-group">-->
<!--                    <label class="form-label" for="confirmPassword">Confirm Password</label>-->
<!--                    <input type="password" class="form-control" id="confirmPassword" [(ngModel)]="currentUser.confirmPassword"-->
<!--                           name="confirmPassword" required placeholder="Confirm your password"/>-->
<!--                </div>-->
<!--            </div>-->
            <div class="row">
                <div class="col-sm-4 mb-3 form-group">
                    <label for="accountType" class="form-label">Type</label>
                    <select id="accountType" [(ngModel)]="currentUser.accountType" name="accountType" class="form-select">
                        <option *ngFor="let type of accountTypes" [value]="type.name">{{ type.id }}</option>
                    </select>
                </div>
                <div class="col-sm-4 mb-3 form-group" *ngIf="currentUser.accountType === 'Dealer'">
                    <label class="form-label" for="parentDealer">Parent Dealer</label>
                    <input type="text" class="form-control" id="parentDealer" [(ngModel)]="currentUser.parentDealer"
                           name="parentDealer" required placeholder="Enter Parent Dealer"/>
                </div>
                <div class="col-sm-4 mb-3 form-group" *ngIf="currentUser.accountType === 'Dealer'">
                    <label class="form-label" for="dealerCode">Dealer Code</label>
                    <input type="text" class="form-control" id="dealerCode" [(ngModel)]="currentUser.dealerCode"
                           name="dealerCode" required placeholder="Enter Dealer Code"/>
                </div>
            </div>
            <div class="row" *ngIf="currentUser.accountType === 'Dealer'">
                <div class="col-sm-6 mb-3 form-group">
                    <label class="form-label" for="primaryContactPerson">Primary Contact Person</label>
                    <input type="text" class="form-control" id="primaryContactPerson" [(ngModel)]="currentUser.primaryContactPerson"
                           name="primaryContactPerson" required placeholder="Enter Primary Contact Person"/>
                </div>
                <div class="col-sm-6 mb-3 form-group">
                    <label class="form-label" for="primaryContactPersonMobile">Primary Contact Person Mobile</label>
                    <input type="text" class="form-control" id="primaryContactPersonMobile" [(ngModel)]="currentUser.primaryContactPersonMobile"
                           maxlength="10" oninput="this.currentUser.primaryContactPersonMobile = this.currentUser.primaryContactPersonMobile.replace(/[^0-9]/g, '').slice(0, 10);"
                           pattern="^\d{10}$" name="primaryContactPersonMobile" required placeholder="Enter Primary Contact Person Mobile"/>
                </div>
            </div>
            <div class="row" *ngIf="currentUser.accountType === 'Dealer'">
                <div class="col-sm-12 mb-3 form-group">
                    <label for="address">Address</label>
                    <textarea class="form-control" id="address" [(ngModel)]="currentUser.address" name="address" rows="3"
                              required placeholder="Enter address"></textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <ol>
                        <li *ngFor="let err of errors; let i = index" style="color: red">{{err}}</li>
                    </ol>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">Close</button>
        <button type="button" class="btn btn-primary" (click)="addNewUser(modal)" [disabled]="userForm.invalid">
            Save
        </button>
    </div>
</ng-template>


<!-- Modal for Edit User -->
<ng-template #editUserModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">Edit User</h4>
    </div>
    <div class="modal-body">
        <!--        <form #userForm="ngForm" (ngSubmit)="updateUser(modal, userForm)">-->
        <form #userForm="ngForm" class="modal-box shadow-sm" (ngSubmit)="updateUser(modal, userForm)">
            <!-- Edit Name -->
            <div class="row">
                <div class="col-sm-6 mb-3 form-group">
                    <label class="form-label" for="name">Name</label>
                    <input type="text" class="form-control" id="name" [(ngModel)]="currentUser.name" name="name"
                           required placeholder="Enter full name"/>
                </div>
                <!--            </div>-->

                <!-- Add Mobile Number (10 digits) -->
                <!--            <div class="row">-->
                <div class="col-sm-6 mb-3 form-group">
                    <label class="form-label" for="mobile">Mobile Number</label>
                    <input type="text" class="form-control" id="mobile" [(ngModel)]="currentUser.mobile" name="mobile"
                           maxlength="10" oninput="this.currentUser.mobile = this.currentUser.mobile.replace(/[^0-9]/g, '').slice(0, 10);"
                           pattern="^\d{10}$" required #mobile="ngModel" placeholder="Enter 10-digit mobile number"/>
                    <div *ngIf="mobile.invalid && mobile.touched" class="text-danger">
                        Mobile number must be exactly 10 digits.
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-4 mb-3 form-group">
                    <label for="accountType" class="form-label">Type</label>
                    <select id="accountType" [(ngModel)]="currentUser.accountType" name="accountType" class="form-select">
                        <option *ngFor="let type of accountTypes" [value]="type.name">{{ type.id }}</option>
                    </select>
                </div>
                <div class="col-sm-4 mb-3 form-group" *ngIf="currentUser.accountType === 'Dealer'">
                    <label class="form-label" for="parentDealer">Parent Dealer</label>
                    <input type="text" class="form-control" id="parentDealer" [(ngModel)]="currentUser.parentDealer"
                           name="parentDealer" required placeholder="Enter Parent Dealer"/>
                </div>
                <div class="col-sm-4 mb-3 form-group" *ngIf="currentUser.accountType === 'Dealer'">
                    <label class="form-label" for="dealerCode">Dealer Code</label>
                    <input type="text" class="form-control" id="dealerCode" [(ngModel)]="currentUser.dealerCode"
                           name="dealerCode" required placeholder="Enter Dealer Code"/>
                </div>
            </div>
            <div class="row" *ngIf="currentUser.accountType === 'Dealer'">
                <div class="col-sm-6 mb-3 form-group">
                    <label class="form-label" for="primaryContactPerson">Primary Contact Person</label>
                    <input type="text" class="form-control" id="primaryContactPerson" [(ngModel)]="currentUser.primaryContactPerson"
                           name="primaryContactPerson" required placeholder="Enter Primary Contact Person"/>
                </div>
                <div class="col-sm-6 mb-3 form-group">
                    <label class="form-label" for="primaryContactPersonMobile">Primary Contact Person Mobile</label>
                    <input type="text" class="form-control" id="primaryContactPersonMobile" [(ngModel)]="currentUser.primaryContactPersonMobile"
                           maxlength="10" oninput="this.currentUser.primaryContactPersonMobile = this.currentUser.primaryContactPersonMobile.replace(/[^0-9]/g, '').slice(0, 10);"
                           pattern="^\d{10}$" name="primaryContactPersonMobile" required placeholder="Enter Primary Contact Person Mobile"/>
                </div>
            </div>
            <div class="row" *ngIf="currentUser.accountType === 'Dealer'">
                <div class="col-sm-12 mb-3 form-group">
                    <label for="address">Address</label>
                    <textarea class="form-control" id="address" [(ngModel)]="currentUser.address" name="address" rows="3"
                              required placeholder="Enter address"></textarea>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <ol>
                        <li *ngFor="let err of errors; let i = index" style="color: red">{{err}}</li>
                    </ol>
                </div>
            </div>

        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">Close</button>
        <button type="button" class="btn btn-primary" [disabled]="userForm.invalid"
                (click)="updateUser(modal, userForm)">Save
        </button>
    </div>
</ng-template>

<!-- Modal for Password Reset -->
<ng-template #resetPasswordModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title">Reset Password</h4>
    </div>
    <div class="modal-body">
        <form #resetPasswordForm="ngForm" (ngSubmit)="resetPassword(modal, resetPasswordForm)">
            <!-- New Password -->
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input
                        type="password"
                        class="form-control"
                        id="newPassword"
                        [(ngModel)]="currentUserResetPasswordForm.newPassword"
                        name="newPassword"
                        required
                        placeholder="Enter new password"
                        #newPassword="ngModel"
                />
                <div *ngIf="newPassword.invalid && newPassword.touched" class="text-danger">
                    New password is required.
                </div>
            </div>

            <!-- Confirm New Password -->
            <div class="form-group">
                <label for="confirmNewPassword">Confirm New Password</label>
                <input
                        type="password"
                        class="form-control"
                        id="confirmNewPassword"
                        [(ngModel)]="currentUserResetPasswordForm.confirmNewPassword"
                        name="confirmNewPassword"
                        required
                        placeholder="Confirm new password"
                        #confirmNewPassword="ngModel"
                />
                <div *ngIf="confirmNewPassword.invalid && confirmNewPassword.touched" class="text-danger">
                    <div *ngIf="confirmNewPassword.errors?.['required']">Confirmation is required.</div>
                    <div *ngIf="newPassword.value !== confirmNewPassword.value">Passwords must match.</div>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="modal.close()">Close</button>
        <button type="button" class="btn btn-primary" [disabled]="resetPasswordForm.invalid"
                (click)="resetPassword(modal, resetPasswordForm)">Reset Password
        </button>
    </div>
</ng-template>